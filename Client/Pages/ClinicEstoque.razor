@page "/clinica/{ClinicIdString}/estoque"
@using Microsoft.AspNetCore.Authorization
@using Shared.DTOs
@using Client.Services
@attribute [Authorize(Roles = "User")]
@inject ClinicService ClinicService
@inject MaterialService MaterialService
@inject IJSRuntime JS

<div class="page-header mb-4">
    <h3>üì¶ Inventory - @(clinicDetails?.Name ?? "Loading...")</h3>
    <p class="text-muted">Manage materials and inventory movements</p>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success">@successMessage</div>
}

@if (clinicDetails == null)
{
    <p>Loading...</p>
}
else
{
    <div class="mb-3">
        <a href="/minhas-clinicas" class="btn btn-secondary">‚Üê Back</a>
    </div>

    <div class="card mb-4 insert-card">
        <div class="card-header insert-card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-dark toggle-collapse"
                        title="@(isInsertSectionCollapsed ? "Expand section" : "Collapse section")"
                        @onclick="ToggleInsertSection">
                    @(isInsertSectionCollapsed ? "+" : "‚àí")
                </button>
                <h5 class="mb-0">‚ûï Insert Material into Clinic Inventory</h5>
            </div>
            @if (!isInsertSectionCollapsed)
            {
                <input class="form-control form-control-sm w-100 w-md-auto"
                       type="search"
                       placeholder="Search material or category"
                       @bind="materialSearchTerm"
                       @bind:event="oninput" />
            }
        </div>
        @if (!isInsertSectionCollapsed)
        {
        <div class="card-body">
            @if (materialsCatalog == null)
            {
                <p>Loading materials catalog..</p>
            }
            else if (!materialsCatalog.Any())
            {
                <p class="text-muted">No materials have been registered. Contact the administrator to add materials.</p>
            }
            else
            {
                var filteredMaterials = FilterMaterialsCatalog().ToList();
                if (!filteredMaterials.Any())
                {
                    <p class="text-muted">No materials found for "@materialSearchTerm".</p>
                }
                else
                {
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Category</th>
                                <th class="text-center">Total in Warehouse</th>
                                <th class="text-center">Total in Clinics</th>
                                <th>Distribution by Clinic</th>
                                <th class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var material in filteredMaterials)
                            {
                                var isLowStock = material.WarehouseQuantity <= 1;
                                <tr class="@(isLowStock ? "table-danger" : string.Empty)">
                                    <td>@material.Name</td>
                                    <td>@material.Category</td>
                                    <td class="text-center">
                                        @if (material.WarehouseQuantity > 0)
                                        {
                                            <strong>@material.WarehouseQuantity</strong>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (material.TotalQuantity > 0)
                                        {
                                            <strong>@material.TotalQuantity</strong>
                                        }
                                        else
                                        {
                                            <span class="text-muted">0</span>
                                        }
                                    </td>
                                    <td class="align-middle">
                                        @if (material.Clinics.Any())
                                        {
                                            <div class="clinic-badges">
                                                @foreach (var clinic in material.Clinics)
                                                {
                                                    <span class="clinic-badge" title="@($"{clinic.ClinicName}: {clinic.Quantity} unidade(s)")">
                                                        @clinic.ClinicName: @clinic.Quantity
                                                    </span>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted small">No clinics have available stock.</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-success"
                                                title="Adicionar material diretamente ao estoque desta cl√≠nica"
                                                @onclick="() => AddMaterialToClinic(material)">
                                            ‚ûï Add
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                }
            }
        </div>
        }
    </div>

    <h5>Estoque da Cl√≠nica</h5>
    @if (!clinicDetails.Stocks.Any())
    {
        <p>This clinic has no materials in stock.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Category</th>
                    <th class="text-center">Available Quantity</th>
                    <th class="text-center">Open</th>
                    <th class="text-center">Open Since</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var stock in clinicDetails.Stocks)
                {
                    var isLowStock = stock.QuantityAvailable <= 1;
                    <tr class="@(isLowStock ? "table-danger" : string.Empty)">
                        <td>@stock.MaterialName</td>
                        <td>@stock.Category</td>
                        <td class="text-center">@stock.QuantityAvailable</td>
                        <td class="text-center">
                            @if (stock.Category == "UsageMaterials" || stock.Category == "Disposables")
                            {
                                <div class="form-check form-switch d-inline-block">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           checked="@stock.IsOpen" 
                                           @onchange="(e) => ToggleOpen(stock, e)"
                                           title="@(stock.IsOpen ? "Marcado como aberto" : "Marcar como aberto")" />
                                    <label class="form-check-label ms-2">
                                        @if (stock.IsOpen)
                                        {
                                            <span class="badge bg-success">Aberto</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Fechado</span>
                                        }
                                    </label>
                                </div>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td class="text-center">
                            @if (stock.IsOpen && stock.OpenedAt is not null)
                            {
                                @stock.OpenedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger"
                                    disabled="@(stock.QuantityAvailable <= 0)"
                                    title="Consumir material do estoque"
                                    @onclick="() => ConsumeMaterial(stock)">
                                Consume
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    [Parameter] public string ClinicIdString { get; set; } = string.Empty;
    private Guid ClinicId => Guid.TryParse(ClinicIdString, out var id) ? id : Guid.Empty;
    ClinicDetailDto? clinicDetails;
    List<MaterialGeneralStockDto>? materialsCatalog;
    string? errorMessage;
    string? successMessage;
    string materialSearchTerm = string.Empty;
    bool isInsertSectionCollapsed;

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(ClinicIdString) && Guid.TryParse(ClinicIdString, out _))
        {
            await LoadClinicDetails();
            await LoadGeneralInventory();
        }
        else if (!string.IsNullOrWhiteSpace(ClinicIdString))
        {
            errorMessage = "Clinic ID is invalid.";
        }
    }

    async Task LoadGeneralInventory()
    {
        try
        {
            materialsCatalog = await MaterialService.GetGeneralSummary();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading materials catalog: {ex.Message}";
        }
    }

    IEnumerable<MaterialGeneralStockDto> FilterMaterialsCatalog()
    {
        if (materialsCatalog == null || !materialsCatalog.Any())
        {
            return Enumerable.Empty<MaterialGeneralStockDto>();
        }

        if (string.IsNullOrWhiteSpace(materialSearchTerm))
        {
            return materialsCatalog;
        }

        var normalized = materialSearchTerm.Trim();
        return materialsCatalog.Where(m =>
            (!string.IsNullOrWhiteSpace(m.Name) && m.Name.Contains(normalized, StringComparison.OrdinalIgnoreCase)) ||
            (!string.IsNullOrWhiteSpace(m.Category) && m.Category.Contains(normalized, StringComparison.OrdinalIgnoreCase)));
    }

    async Task LoadClinicDetails()
    {
        try
        {
            if (!Guid.TryParse(ClinicIdString, out var clinicId) || clinicId == Guid.Empty)
            {
                errorMessage = "Invalid clinic ID.";
                return;
            }

            clinicDetails = await ClinicService.Get(clinicId);
            if (clinicDetails == null)
            {
                errorMessage = "Clinic not found.";
            }
            else
            {
                errorMessage = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading clinic details: {ex.Message}";
            clinicDetails = null;
        }
    }

    async Task ConsumeMaterial(ClinicStockDto stock)
    {
        errorMessage = null;
        successMessage = null;

        if (stock.QuantityAvailable <= 0)
        {
            errorMessage = "No available quantity to consume.";
            return;
        }

        var input = await JS.InvokeAsync<string?>("prompt", 
            $"Quantity of '{stock.MaterialName}' to consume (maximum: {stock.QuantityAvailable})", "1");

        if (string.IsNullOrWhiteSpace(input))
            return;

        if (!int.TryParse(input, out var quantity) || quantity <= 0)
        {
            errorMessage = "Please enter a valid quantity.";
            return;
        }

        if (quantity > stock.QuantityAvailable)
        {
            errorMessage = $"Requested quantity ({quantity}) exceeds available stock ({stock.QuantityAvailable}).";
            return;
        }

        if (!Guid.TryParse(ClinicIdString, out var clinicId))
        {
            errorMessage = "Invalid clinic ID.";
            return;
        }

        var response = await ClinicService.ConsumeMaterial(clinicId, new ClinicConsumeRequest(stock.MaterialId, quantity));

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            errorMessage = $"Error consuming material: {error}";
            return;
        }

        successMessage = "Material successfully consumed! Remaining quantity updated.";
        await LoadClinicDetails();
        await LoadGeneralInventory();
    }

    async Task AddMaterialToClinic(MaterialGeneralStockDto material)
    {
        errorMessage = null;
        successMessage = null;

        if (!Guid.TryParse(ClinicIdString, out var clinicId))
        {
            errorMessage = "Invalid clinic ID.";
            return;
        }

        var input = await JS.InvokeAsync<string?>("prompt",
            $"Quantity of '{material.Name}' to add to clinic inventory",
            "1");

        if (string.IsNullOrWhiteSpace(input))
            return;

        if (!int.TryParse(input, out var quantity) || quantity <= 0)
        {
            errorMessage = "Please enter a valid quantity.";
            return;
        }

        var response = await ClinicService.AddStock(clinicId, new ClinicAddStockRequest(material.Id, quantity));

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            errorMessage = $"Error adding material: {error}";
            return;
        }

        successMessage = $"Material successfully added! {quantity} unit(s) of '{material.Name}' have been registered in inventory.";
        await LoadClinicDetails();
        await LoadGeneralInventory();
    }

    async Task ToggleOpen(ClinicStockDto stock, ChangeEventArgs e)
    {
        errorMessage = null;
        successMessage = null;

        if (stock.Category != "UsageMaterials" && stock.Category != "Disposables")
        {
            errorMessage = "Only usage and disposable materials can be marked as open.";
            return;
        }

        if (!Guid.TryParse(ClinicIdString, out var clinicId))
        {
            errorMessage = "Invalid clinic ID.";
            return;
        }

        var isChecked = false;
        if (e.Value is bool b)
        {
            isChecked = b;
        }
        else if (e.Value is string str && bool.TryParse(str, out var parsed))
        {
            isChecked = parsed;
        }

        var response = await ClinicService.SetStockOpen(clinicId, stock.MaterialId, isChecked);

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            errorMessage = $"Error changing material status: {error}";
            // Revert checkbox
            await LoadClinicDetails();
            return;
        }

        successMessage = $"Material successfully marked as {(isChecked ? "open" : "closed")}!";
        await LoadClinicDetails();
    }

    void ToggleInsertSection() => isInsertSectionCollapsed = !isInsertSectionCollapsed;
}

<style>
    .page-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .insert-card-header {
        background-color: #050505 !important;
        background-image: none !important;
        color: #22c55e;
        border-bottom: none;
    }

    .insert-card-header h5 {
        color: #22c55e;
    }

    .insert-card-header .toggle-collapse {
        width: 32px;
        height: 32px;
        padding: 0;
        border-radius: 50%;
        line-height: 1;
    }

    .insert-card-header input {
        max-width: 320px;
    }

    .clinic-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
    }

    .clinic-badge {
        background: #e9f2ff;
        color: #1d4ed8;
        border-radius: 999px;
        padding: 0.3rem 0.65rem;
        font-weight: 600;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }
</style>

