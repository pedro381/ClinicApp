@page "/clinicas"
@using Microsoft.AspNetCore.Authorization
@using Shared.DTOs
@attribute [Authorize(Roles = "Master")]
@inject ClinicService ClinicService
@inject MaterialService MaterialService
@inject IJSRuntime JS

<div class="page-header mb-4">
    <h3>🏥 Gerenciar Clínicas</h3>
    <p class="text-muted">Controle centralizado de estoque e distribuição de materiais</p>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (clinics == null || materials == null)
{
    <p>Carregando...</p>
}
else
{
    <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
        <span class="fw-semibold">Clínicas:</span>
        @foreach (var c in clinics)
        {
            <button class="btn @(selectedClinic?.Id == c.Id ? "btn-primary" : "btn-outline-primary")"
                    @onclick="() => SelectClinic(c)">
                @c.Name
            </button>
        }
    </div>

    <h4>Estoque Geral</h4>
    @if (!materials.Any())
    {
        <p>Nenhum material cadastrado.</p>
    }
    else
    {
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Material</th>
                    <th>Categoria</th>
                    <th class="text-center">Disponível</th>
                    <th class="text-center">Distribuídos</th>
                    <th class="text-center">Total</th>
                    <th>Status nas Clínicas</th>
                    <th class="text-end">Ações</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var material in materials)
                {
                    var total = material.Quantity + material.DistributedQuantity;
                    <tr>
                        <td>@material.Name</td>
                        <td>@material.Category</td>
                        <td class="text-center">@material.Quantity</td>
                        <td class="text-center">
                            <span class="badge bg-info">@material.DistributedQuantity</span>
                        </td>
                        <td class="text-center">
                            <strong>@total</strong>
                        </td>
                        <td>
                            @if ((material.Category == "MateriaisDeUso" || material.Category == "Descartaveis") && material.OpenInClinics.Any())
                            {
                                <div class="small">
                                    @foreach (var clinicStatus in material.OpenInClinics)
                                    {
                                        <div class="mb-1">
                                            <span class="badge @(clinicStatus.IsOpen ? "bg-success" : "bg-secondary")">
                                                @clinicStatus.ClinicName: @(clinicStatus.IsOpen ? "Aberto" : "Fechado")
                                            </span>
                                            @if (clinicStatus.IsOpen && clinicStatus.OpenedAt.HasValue)
                                            {
                                                <span class="text-muted small ms-1">
                                                    (desde @clinicStatus.OpenedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm"))
                                                </span>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            else if (material.Category == "MateriaisDeUso" || material.Category == "Descartaveis")
                            {
                                <span class="text-muted small">Nenhuma clínica com estoque</span>
                            }
                            else
                            {
                                <span class="text-muted small">-</span>
                            }
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary"
                                    disabled="@(selectedClinic == null || material.Quantity <= 0)"
                                    title="Distribuir para clínica selecionada"
                                    @onclick="() => AllocateMaterial(material)">
                                Distribuir
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="text-muted small">
            @(selectedClinic == null
                ? "Selecione uma clínica para distribuir materiais."
                : $"Distribuir materiais para {selectedClinic.Name}.")
        </p>
    }

    @if (selectedClinic != null)
    {
        <section class="mt-4">
            <h4>Estoque de @selectedClinic.Name</h4>
            @if (clinicDetails == null)
            {
                <p>Carregando detalhes...</p>
            }
            else
            {
                if (!clinicDetails.Stocks.Any())
                {
                    <p>Esta clínica ainda não possui materiais.</p>
                }
                else
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Categoria</th>
                                <th>Quantidade</th>
                                <th class="text-center">Aberto?</th>
                                <th>Desde</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var s in clinicDetails.Stocks)
                            {
                                <tr>
                                    <td>@s.MaterialName</td>
                                    <td>@s.Category</td>
                                    <td>@s.QuantityAvailable</td>
                                    <td class="text-center">
                                        @if (s.Category == "MateriaisDeUso" || s.Category == "Descartaveis")
                                        {
                                            <input type="checkbox" checked="@s.IsOpen" @onchange="(e) => ToggleOpen(s, e)" />
                                        }
                                        else
                                        {
                                            <span>-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (s.IsOpen && s.OpenedAt is not null)
                                        {
                                            @s.OpenedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Últimas Movimentações</h5>
                    @if (clinicDetails.Movements.Any())
                    {
                        <button class="btn btn-sm btn-outline-danger" 
                                title="Limpar log de movimentações"
                                @onclick="ClearMovements">
                            🗑️ Limpar Log
                        </button>
                    }
                </div>
                @if (!clinicDetails.Movements.Any())
                {
                    <p>Nenhuma movimentação registrada.</p>
                }
                else
                {
                    <ul class="list-unstyled">
                        @foreach (var m in clinicDetails.Movements)
                        {
                            <li>
                                <strong>@m.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss"):</strong>
                                @m.MovementType - @m.Quantity - por @m.PerformedBy
                                @if (!string.IsNullOrWhiteSpace(m.Note))
                                {
                                    <span class="text-muted"> (@m.Note)</span>
                                }
                                <span class="text-primary fw-semibold"> = @m.MaterialName</span>
                            </li>
                        }
                    </ul>
                }
            }
        </section>
    }
}

@code {
    List<ClinicDto>? clinics;
    List<MaterialWithOpenStatusDto>? materials;
    ClinicDto? selectedClinic;
    ClinicDetailDto? clinicDetails;
    string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        clinics = await ClinicService.GetAll();
        materials = await MaterialService.GetAllWithOpenStatus();
    }

    async Task SelectClinic(ClinicDto c)
    {
        selectedClinic = c;
        errorMessage = null;
        clinicDetails = await ClinicService.Get(c.Id);
        if (clinicDetails == null)
        {
            errorMessage = "Não foi possível carregar os detalhes da clínica selecionada.";
        }
    }

    async Task AllocateMaterial(MaterialWithOpenStatusDto material)
    {
        errorMessage = null;

        if (selectedClinic == null)
            return;

        var input = await JS.InvokeAsync<string?>("prompt", $"Quantidade para enviar '{material.Name}' a {selectedClinic.Name}", "1");
        if (string.IsNullOrWhiteSpace(input))
            return;

        if (!int.TryParse(input, out var quantity) || quantity <= 0)
        {
            errorMessage = "Informe uma quantidade válida.";
            return;
        }

        var response = await ClinicService.Allocate(selectedClinic.Id, new ClinicAllocateRequest(material.Id, quantity));
        if (!response.IsSuccessStatusCode)
        {
            errorMessage = await response.Content.ReadAsStringAsync();
            return;
        }

        clinicDetails = await ClinicService.Get(selectedClinic.Id);
        if (clinicDetails == null)
        {
            errorMessage = "Não foi possível atualizar os dados da clínica após a distribuição.";
        }
        materials = await MaterialService.GetAllWithOpenStatus();
    }

    async Task ToggleOpen(ClinicStockDto stock, ChangeEventArgs e)
    {
        errorMessage = null;

        if (selectedClinic == null)
            return;

        var isChecked = false;
        if (e.Value is bool b)
        {
            isChecked = b;
        }
        else if (e.Value is string str && bool.TryParse(str, out var parsed))
        {
            isChecked = parsed;
        }

        var response = await ClinicService.SetStockOpen(selectedClinic.Id, stock.MaterialId, isChecked);
        if (!response.IsSuccessStatusCode)
        {
            errorMessage = await response.Content.ReadAsStringAsync();
            return;
        }

        clinicDetails = await ClinicService.Get(selectedClinic.Id);
        if (clinicDetails == null)
        {
            errorMessage = "Não foi possível atualizar os dados da clínica.";
        }
        materials = await MaterialService.GetAllWithOpenStatus();
    }

    async Task ClearMovements()
    {
        errorMessage = null;

        if (selectedClinic == null)
        {
            errorMessage = "Selecione uma clínica primeiro.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm", 
            "Tem certeza que deseja limpar todo o log de movimentações? Esta ação não pode ser desfeita.");

        if (!confirmed)
            return;

        var response = await ClinicService.ClearMovements(selectedClinic.Id);

        if (!response.IsSuccessStatusCode)
        {
            var error = await response.Content.ReadAsStringAsync();
            errorMessage = $"Erro ao limpar log: {error}";
            return;
        }

        clinicDetails = await ClinicService.Get(selectedClinic.Id);
        if (clinicDetails == null)
        {
            errorMessage = "Não foi possível atualizar os dados da clínica após limpar o log.";
        }
    }
}

<style>
    .page-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }

    .list-unstyled li {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        transition: all 0.2s ease;
    }

    .list-unstyled li:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }
</style>
